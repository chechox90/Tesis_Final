
@{
    ViewBag.Title = "AdministrarSolicitud";
}

<style>
    .borderInput {
        margin: 10px;
    }

    .divFlot {
        text-align: right
    }
</style>

<div class="page-title">
    <div class="content-title">
        <h3>Solicitudes</h3>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#"><i class="fas fa-home"></i></a></li>
                <li class="breadcrumb-item"><a href="#">Mi horario</a></li>
                <li class="breadcrumb-item active" aria-current="page"><a href="#">Solicitudes</a></li>
            </ol>
        </nav>
    </div>
</div>

<br />

<div class="card">
    <div class="modal-body">
        <div class="form-row contiener-row">
            <div class="col-md-4">
                <div class="form-group text-right">
                    <label for="Terminal">Terminal</label>
                    <select id="ddlTerminal" name="Terminal" class="form-control"></select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group text-right">
                    <label for="txtNumeroInterno">Tipo de Solicitud</label>
                    <select id="cmbTipoSolicitud" class="form-control"></select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="container text-right">
                    <div class="form-group">
                        <label>Fecha</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text pr-01"><i class="far fa-calendar-alt"></i></span>
                            </div>
                            <input type="text" class="form-control dateinput opacity-1" id="txtFechaInicio" name="daterange" autocomplete="off" required="" readonly="" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-outline-light" onkeypress="ClicBuscar();" onclick="Limpiar();">Limpiar</button>
        <button type="button" class="btn btn-success" id="btnGuardarNuevo" onclick="ObtenerSolictud();"><i class="fas fa-search"></i>  Buscar</button>
    </div>
</div>

<br />

<div class="col-md-12 card" style="padding:15px" id="divTablaUno">
    <h4 class="text-success">Solicitudes</h4>
    <table id="tblSolicitudes" class="table table-striped table-hover">
    </table>
</div>

<div class="modal fade" id="modalComentario" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content shadow">
            <div class="modal-title">
                <div class="text-center">
                    <h3 class="text-primary">Motivo</h3>
                </div>
            </div>
            <div class="modal-body">
                <div>
                    <span id="lblMotivo"></span>
                </div>
                <div>
                    <span id="lblComentarioAdicional"></span>
                </div>
            </div>
            <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="btnEliminar" onclick="CerrarModal();"><i class="fas fa-check"></i> Acpetar</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="modalConfirmacion" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content shadow">
            <div class="modal-title">
                <div class="text-center">
                    <h3 class="text-primary">Información</h3>
                </div>
            </div>
            <div class="modal-body">
                <div>
                    <label for="cmbTipoRespuesta">Ingresar Respuesta</label>
                    <select id="cmbTipoRespuesta" class="form-control"></select>
                </div>
                <label id="txtIdSolicitud" style="display:none"></label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" id="btnCancela" onclick="CerrarModal();">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnGuardar" onclick="GuardarNuevoEstadoSolicitud();"><i class="fas fa-check"></i> Guardar</button>
            </div>
        </div>
    </div>
</div>

@section scripts
    {
    <script>
        var tblSolicitud;
        $(document).ready(function () {
            //datepicker range
            $(function () {
                $('input[name="daterange"]').daterangepicker({
                    opens: "left",
                    startDate: moment().startOf('month'),
                    endDate: moment().endOf('month'),
                    minDate: "26/10/2020",
                    maxDate: "31/12/" + ((new Date).getFullYear() + 1),
                    dateLimit: {
                        'days': 30
                    },
                    locale: {
                        format: 'DD/MM/YYYY',
                        customRangeLabel: "Rango personalizado",
                        applyLabel: "Aplicar",
                        cancelLabel: "Cancelar",
                        fromLabel: "Desde",
                        toLabel: "To",
                        weekLabel: "W",
                        daysOfWeek: [
                            'Do',
                            'Lu',
                            'Ma',
                            'Mi',
                            'Ju',
                            'Vi',
                            'Sa'
                        ],
                        monthNames: [
                            'Enero',
                            'Febrero',
                            'Marzo',
                            'Abril',
                            'Mayo',
                            'Junio',
                            'Julio',
                            'Agosto',
                            'Septiembre',
                            'Octubre',
                            'Noviembre',
                            'Diciembre'
                        ],
                        firstDay: 1
                    },
                    showDropdowns: true,
                    alwaysShowCalendars: true,
                    ranges: {
                        'Hoy': [moment(), moment()],
                        'Ayer': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                        'Últimos 7 días': [moment().subtract(6, 'days'), moment()],
                        'Últimos 30 días': [moment().subtract(29, 'days'), moment()],
                        'Mes Actual': [moment().startOf('month'), moment().endOf('month')],
                        'Mes Pasado': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                    },
                });
            });
            CargarCmb();

            ObtenerSolictud();
        });

        function CargarCmb() {
            $.ajax({
                url: '../HorarioConductor/GetTipoSolicitudesCmb',
                type: 'post',
                datatype: 'json',
                async: false,
                data: null,
                success: function (data) {
                    for (var i = 0; i < data.data.length; i++) {
                        var option = $(document.createElement('option'));
                        option.val(data.data[i]["ID_TIPO_SOLICITUD"]);
                        option.text(data.data[i]["NOMBRE_SOLICITUD"]);

                        $("#cmbTipoSolicitud").append(option);
                    }
                }
            });

            $.ajax({
                url: '../HorarioConductor/GetTipoSolicitudesRespuesta',
                type: 'post',
                datatype: 'json',
                async: false,
                data: null,
                success: function (data) {
                    for (var i = 0; i < data.data.length; i++) {
                        var option = $(document.createElement('option'));
                        option.val(data.data[i]["ID_ESTADO_SOLICITUD"]);
                        option.text(data.data[i]["NOMBRE_ESTADO"]);

                        $("#cmbTipoRespuesta").append(option);
                    }
                }
            });

            $.ajax({
                url: '../Mantenedor/GetCargarTerminalesCmb',
                type: 'post',
                datatype: 'json',
                async: false,
                data: {},
                success: function (data) {
                    for (var i = 0; i < data.data.length; i++) {
                        var optionTer = $(document.createElement('option'));
                        optionTer.val(data.data[i]["ID_TERMINAL"]);
                        optionTer.text(data.data[i]["NOMBRE_TERMINAL"]);

                        $("#ddlTerminal").append(optionTer);
                    }
                }
            });
            
        }

        function ObtenerSolictud() {
            var fechaPorRango = $("#txtFechaInicio").val();
            var fIni = (fechaPorRango.split("-")[0]);
            var fFin = (fechaPorRango.split("-")[1]);
            var idTipoSolicitud = $("#cmbTipoSolicitud option:selected").val();
            var idTerminal = $("#cmbTipoSolicitud option:selected").val();

            console.log(fIni)
            if (fIni.length < 3) {
                fIni = '01/01/2021 00:00:00';
                fFin = '01/01/2021 00:00:00';
            }

            tblSolicitud = $("#tblSolicitudes").DataTable({
                scrollX: true,
                processing: true,
                destroy: true,
                lengthChange: false,
                searching: false,
                paging: false,
                info: false,
                language: {
                    "url": "../Plugins/DataTables/js/Spanish.json"
                },
                order: [[0, "asc"]],
                initComplete: function (full, data) {
                    if (data.data.length == 0) {
                        respuesta = "No existen solicitudes para mostrar";
                    }
                    $($.fn.dataTable.tables(true)).DataTable().columns.adjust();

                },
                ajax: {
                    url: "../HorarioConductor/GetSolictudes",
                    type: "POST",
                    dataType: "json",
                    data: {
                        "fechaIni": fIni,
                        "fechaFin": fFin,
                        "tipoSolicitud": idTipoSolicitud,
                        "idTerminal": idTerminal
                    }
                },
                columns: [
                    { data: "ID_SOLICITUD_CAMBIO", visible: false },
                    { data: "ID_HORARIO", visible: false },
                    { data: "NOMBRE_SOLICITA", title: "Usuario Solicita", name: "NOMBRE_SOLICITA" },
                    { data: "RUN_SOLICITA", title: "R.U.N", name: "RUT_USUARIO" },
                    { data: "ESTADO_SOLICITUD", title: "Estado solicitud", name: "ESTADO_SOLICITUD" },
                    {
                        data: null, title: "Fecha registro", name: "FECHA_REGISTRO_SOLICITUD", orderable: false, render:
                            function (full) {
                                if (moment(full.FECHA_REGISTRO_SOLICITUD).format('DD/MM/YYYY') != '31/12/0000') {
                                    return moment(full.FECHA_REGISTRO_SOLICITUD).format('DD/MM/YYYY');
                                } else {
                                    return "";
                                }

                            }
                    },
                    {
                        title: "Ver Motivo",
                        orderable: false,
                        render: function (data, type, full, meta) {
                            var html = '';
                            html = '<a role="button" class="btn-table-bg" onclick="MostrarMotivo(' + "'" + full.COMENTARIO_MOTIVO + "'" + ',' + "'" + full.COMENTARIO_ADICIONAL + "'" + ');"><i class="far fa-eye text-success"</i></a>';
                            return html;

                        }
                    },
                    {
                        data: null, title: "Fecha programada", name: "FECHA_PROGRAMADA", orderable: false, render:
                            function (full) {
                                if (moment(full.FECHA_PROGRAMADA).format('DD/MM/YYYY') != '31/12/0000') {
                                    return moment(full.FECHA_PROGRAMADA).format('DD/MM/YYYY');
                                } else {
                                    return "";
                                }

                            }
                    },
                    { data: "NOMBRE_TERMINAL", title: "Terminal presentación", name: "NOMBRE_TERMINAL" },
                    {
                        title: "Gestión",
                        orderable: false,
                        render: function (data, type, full, meta) {
                            var html = '';

                            html = '<a role="button" class="btn-table-bg" onclick="ShowIngresaSolicitud(' + full.ID_SOLICITUD_CAMBIO + ');"><i class="far fa-edit text-success"</i></a>';
                            return html;

                        }
                    },
                ]
            });
        }

        function MostrarMotivo(comentario, comentarioAdicional) {
            $("#lblMotivo").text(comentario);
            $("#lblComentarioAdicional").text(comentarioAdicional);
            $("#modalComentario").modal("show");
        }

        function CerrarModal() {
            $("#modalConfirmacion").modal("hide");
            $("#modalComentario").modal("hide");
        }

        function ShowIngresaSolicitud(idSolicitud) {
            $("#txtIdSolicitud").val(idSolicitud);
            $("#modalConfirmacion").modal("show");
        }

        function GuardarNuevoEstadoSolicitud() {
            let IdSolicitud = $("#txtIdSolicitud").val();
            let idEstadoSolicitud = $("#cmbTipoRespuesta option:selected").val();

            if (idEstadoSolicitud > 0) {
                $.ajax({
                    url: '../HorarioConductor/SetIngresaRespuestaSolictud',
                    type: 'post',
                    datatype: 'json',
                    async: false,
                    data: {
                        "idSolicitud": IdSolicitud,
                        "idEstadoSolicitud": idEstadoSolicitud
                    },
                    success: function (data) {
                        if (data.Data.alert != '') {
                            alertSuccess(data.Data.message)

                            CerrarModal();

                            $("#cmbTipoRespuesta option").attr("selected", false);
                            $("cmbTipoRespuesta option[value='" + 0 + "']").attr("selected", "selected");

                            tblSolicitud.ajax.reload(null, false);
                        }
                    }
                });
            } else {
                alertDanger("Seleccione una respuesta para continuar.")
            }
            

        }

    </script>
}

